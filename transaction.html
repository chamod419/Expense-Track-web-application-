<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track My Cash - Transactions</title>
    <link rel="stylesheet" href="Css/transaction.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .sidebar {
      width: 250px;
      background-color: #1b3d5f;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      position: fixed;
      height: 100%;
      top: 0;
      left: 0;
      color: white;
    }
    
    .sidebar a {
            color: white;
            text-decoration: none;
            padding: 5px;
            display: block;
            font-size: 18px;
            }
    
    
        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-bottom: 40px;
        }
    
        .logo svg {
            width: 100px;
            height: 100px;
        }
    
        .logo-name {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-top: 10px;
        }
    
        .menu-section {
            padding-left: 20px;
        }
    
        .menu-section h3 {
            color: #ccc;
            margin-bottom: 10px;
        }
    
        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
        }
    
        .menu-item i {
            margin-right: 15px;
            font-size: 20px;
        }
    
        .menu-item:hover {
            background-color: #444;
        }
    
        .menu-item a {
            text-decoration: none;
            color: white;
            font-size: 16px;
        }
    
        
        .main-content {
            margin-left: 250px; 
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            
            <div class="logo">
                <svg width="100" height="100" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M86.8467 11.5997H42.1533C22.74 11.5997 11.1667 23.173 11.1667 42.5863V87.2263C11.1667 106.693 22.74 118.266 42.1533 118.266H86.7933C106.207 118.266 117.78 106.693 117.78 87.2797V42.5863C117.833 23.173 106.26 11.5997 86.8467 11.5997ZM41.1933 97.733C41.1933 99.9197 39.38 101.733 37.1933 101.733C35.0067 101.733 33.1933 99.9197 33.1933 97.733V86.693C33.1933 84.5063 35.0067 82.693 37.1933 82.693C39.38 82.693 41.1933 84.5063 41.1933 86.693V97.733ZM68.5 97.733C68.5 99.9197 66.6867 101.733 64.5 101.733C62.3133 101.733 60.5 99.9197 60.5 97.733V75.5997C60.5 73.413 62.3133 71.5997 64.5 71.5997C66.6867 71.5997 68.5 73.413 68.5 75.5997V97.733ZM95.8067 97.733C95.8067 99.9197 93.9933 101.733 91.8067 101.733C89.62 101.733 87.8067 99.9197 87.8067 97.733V64.5597C87.8067 62.373 89.62 60.5597 91.8067 60.5597C93.9933 60.5597 95.8067 62.373 95.8067 64.5597V97.733ZM95.8067 47.7063C95.8067 49.893 93.9933 51.7063 91.8067 51.7063C89.62 51.7063 87.8067 49.893 87.8067 47.7063V42.533C74.2067 56.5063 57.1933 66.373 38.1533 71.1197C37.8333 71.2263 37.5133 71.2263 37.1933 71.2263C35.38 71.2263 33.78 69.9997 33.3 68.1863C32.7667 66.053 34.0467 63.8663 36.2333 63.333C54.2067 58.853 70.2067 49.413 82.9 36.0797H76.2333C74.0467 36.0797 72.2333 34.2663 72.2333 32.0797C72.2333 29.893 74.0467 28.0797 76.2333 28.0797H91.86C92.0733 28.0797 92.2333 28.1863 92.4467 28.1863C92.7133 28.2397 92.98 28.2397 93.2467 28.3463C93.5133 28.453 93.7267 28.613 93.9933 28.773C94.1533 28.8797 94.3133 28.933 94.4733 29.0397C94.5267 29.093 94.5267 29.1463 94.58 29.1463C94.7933 29.3597 94.9533 29.573 95.1133 29.7863C95.2733 29.9997 95.4333 30.1597 95.4867 30.373C95.5933 30.5863 95.5933 30.7997 95.6467 31.0663C95.7 31.333 95.8067 31.5997 95.8067 31.9197C95.8067 31.973 95.86 32.0263 95.86 32.0797V47.7063H95.8067Z" fill="#2CD7AE"/>
                </svg>
                <div class="logo-name">Track My Cash</div>
            </div>

            <div class="menu-section">
                <h3>Manage</h3>
                <div class="menu-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <a href="Dashboard.html">Dashboard</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <a href="transaction.html">Transactions</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <a href="report.html">Reports</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-tags"></i>
                    <a href="category.html">Categories</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-wallet"></i>
                    <a href="budget.html">Budget</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-file-invoice"></i>
                    <a href="receipts.html">Receipts</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-bullseye"></i>
                    <a href="goals.html">Goals</a>
                </div>
            </div>

           
            <div class="menu-section">
                <h3>Preferences</h3>
                <div class="menu-item">
                    <i class="fas fa-bell"></i>
                    <a href="notification.html">Notifications</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-cog"></i>
                    <a href="settings.html">Settings</a>
                </div>
            </div>
        </aside>

    
        <main class="main-content">
            <header>
                <h1>Transactions</h1>
                <div class="filter-options">
                    <select id="transactionFilter">
                        <option value="all">All Transactions</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <button id="addButton">Add</button>
                    <select id="sortBy">
                        <option value="date">Sort by Date</option>
                        <option value="amount">Sort by Amount</option>
                    </select>
                </div>
            </header>

           
            <section id="transactionList">
            
            </section>
        </main>
    </div>

   
    <div id="addTransactionPopup" class="popup hidden">
        <div class="popup-content">
            <h2>Select Your Need</h2>
            <button class="type-button" data-type="income">Income</button>
            <button class="type-button" data-type="expense">Expense</button>
        </div>
    </div>

  
    <div id="expenseFormPopup" class="popup hidden">
        <div class="popup-content">
            <h2>Expense Form</h2>
            <form id="expenseForm">
                <label for="expenseName">Name:</label>
                <input type="text" id="expenseName" name="name" required>

                <label for="expenseDate">Date:</label>
                <input type="date" id="expenseDate" name="date" required>

                <label for="expensePrice">Price:</label>
                <input type="number" id="expensePrice" name="amount" required>

                <label for="expenseDescription">Description:</label>
                <input type="text" id="expenseDescription" name="description" required>

                <button type="submit">Submit</button>
                <button type="button" id="closeExpenseForm">Close</button>
            </form>
        </div>
    </div>

   
    <div id="incomeFormPopup" class="popup hidden">
        <div class="popup-content">
            <h2>Income Form</h2>
            <form id="incomeForm">
                <label for="incomeName">Name:</label>
                <input type="text" id="incomeName" name="name" required>

                <label for="incomeDate">Date:</label>
                <input type="date" id="incomeDate" name="date" required>

                <label for="incomeAmount">Amount:</label>
                <input type="number" id="incomeAmount" name="amount" required>

                <label for="incomeDescription">Description:</label>
                <input type="text" id="incomeDescription" name="description" required>

                <button type="submit">Submit</button>
                <button type="button" id="closeIncomeForm">Close</button>
            </form>
        </div>
    </div>

    <script src="transaction.js"></script>
  <script>document.getElementById('addButton')?.addEventListener('click', () => {
    const popup = document.getElementById('addTransactionPopup');
    if (popup) {
        popup.classList.remove('hidden');
    }
});

document.querySelectorAll('.type-button').forEach(button => {
    button.addEventListener('click', (e) => {
        const type = e.target.getAttribute('data-type');
        const popup = document.getElementById('addTransactionPopup');
        if (popup) {
            popup.classList.add('hidden');
        }

        if (type === 'expense') {
            showForm('expenseFormPopup');
        } else if (type === 'income') {
            showForm('incomeFormPopup');
        }
    });
});

function showForm(formId) {
    const form = document.getElementById(formId);
    if (form) {
        form.classList.remove('hidden');
    }
}

document.getElementById('closeExpenseForm')?.addEventListener('click', () => closeForm('expenseFormPopup'));
document.getElementById('closeIncomeForm')?.addEventListener('click', () => closeForm('incomeFormPopup'));

function closeForm(formId) {
    const form = document.getElementById(formId);
    if (form) {
        form.classList.add('hidden');
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-GB', options); 
}

function updateTransactionList(transaction) {
    const transactionList = document.getElementById('transactionList');
    const transactionItem = document.createElement('div');
    transactionItem.classList.add('transaction-item');
    transactionItem.setAttribute('data-type', transaction.type); 

    const shortDescription = transaction.description && transaction.description.length > 20 
        ? transaction.description.slice(0, 20) 
        : transaction.description;

    transactionItem.innerHTML = `
        <div class="date">${formatDate(transaction.date)}</div>
        <div class="details">
            <span>${transaction.name}</span>
            <select>
                <option selected>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</option>
            </select>
            <span class="description">${shortDescription}</span>
            <i class="fa fa-ellipsis-h toggle-description"></i>
        </div>
        <div class="amount ${transaction.type === 'expense' ? 'negative' : 'positive'}">LKR ${transaction.amount}</div>
        <div class="actions">
            <button class="edit-btn"><i class="fa fa-pencil" aria-hidden="true"></i></button>
            <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
        </div>
    `;

    transactionList.appendChild(transactionItem);

    const deleteButton = transactionItem.querySelector('.delete-btn');
    deleteButton.addEventListener('click', () => {
        transactionItem.remove();
    });

    const editButton = transactionItem.querySelector('.edit-btn');
    editButton.addEventListener('click', () => handleEdit(transactionItem, transaction));

    const toggleButton = transactionItem.querySelector('.toggle-description');
    const descriptionSpan = transactionItem.querySelector('.description');
    
    let isExpanded = false;
    
    toggleButton.addEventListener('click', () => {
        isExpanded = !isExpanded; 
        if (isExpanded) {
            descriptionSpan.textContent = transaction.description;
            descriptionSpan.classList.add('expanded');
        } else {
            descriptionSpan.textContent = shortDescription;
            descriptionSpan.classList.remove('expanded');
        }
    });
}

function handleEdit(transactionItem, transaction) {
    // Creating an editing form
    const editForm = document.createElement('form');
    editForm.id = 'editTransactionForm';
    editForm.innerHTML = `
        <label for="editName">Transaction Name:</label>
        <input type="text" id="editName" value="${transaction.name}" required>
        <label for="editAmount">Amount:</label>
        <input type="number" id="editAmount" value="${transaction.amount}" required>
        <label for="editDate">Date:</label>
        <input type="date" id="editDate" value="${transaction.date}" required>
        <button type="submit">Update Transaction</button>
        <button type="button" id="closeEditForm">Cancel</button>
    `;

   
    transactionItem.innerHTML = ''; 
    transactionItem.appendChild(editForm);

   
    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newName = editForm.editName.value;
        const newAmount = editForm.editAmount.value;
        const newDate = editForm.editDate.value;

        if (newName && newAmount && newDate) {
            transactionItem.innerHTML = `
                <div class="date">${formatDate(newDate)}</div>
                <div class="details">
                    <span>${newName}</span>
                    <select>
                        <option selected>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</option>
                    </select>
                    <span class="description">${transaction.description}</span>
                </div>
                <div class="amount ${transaction.type === 'expense' ? 'negative' : 'positive'}">LKR ${newAmount}</div>
                <div class="actions">
                    <button class="edit-btn"><i class="fa fa-pencil" aria-hidden="true"></i></button>
                    <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            updateTransactionList({ ...transaction, name: newName, amount: newAmount, date: newDate });
        }
    });


    document.getElementById('closeEditForm').addEventListener('click', () => {
        transactionItem.innerHTML = `
            <div class="date">${formatDate(transaction.date)}</div>
            <div class="details">
                <span>${transaction.name}</span>
                <select>
                    <option selected>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</option>
                </select>
                <span class="description">${transaction.description}</span>
            </div>
            <div class="amount ${transaction.type === 'expense' ? 'negative' : 'positive'}">LKR ${transaction.amount}</div>
            <div class="actions">
                <button class="edit-btn"><i class="fa fa-pencil" aria-hidden="true"></i></button>
                <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
            </div>
        `;
    });
}

function filterTransactions(filterType) {
    const transactions = document.querySelectorAll('.transaction-item');
    transactions.forEach(transaction => {
        const transactionType = transaction.getAttribute('data-type');
        if (filterType === 'all' || transactionType === filterType) {
            transaction.style.display = 'flex'; 
        } else {
            transaction.style.display = 'none';  
        }
    });
}

document.getElementById('expenseForm')?.addEventListener('submit', handleSubmit);
document.getElementById('incomeForm')?.addEventListener('submit', handleSubmit);

function handleSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    data.type = form.id.replace('Form', '').toLowerCase();
    data.type = data.type.charAt(0).toUpperCase() + data.type.slice(1);

    fetch('http://localhost:3000/add-transaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
        .then(response => response.json())
        .then(result => {
            if (result.message === 'Transaction added successfully') {
                alert('Transaction added successfully!');
                updateTransactionList(data); 
                closeForm(form.parentElement.parentElement.id); 
                form.reset(); 
            } else {
                alert('Failed to add the transaction. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add the transaction. Please try again.');
        });
}

document.getElementById('transactionFilter')?.addEventListener('change', (e) => {
    const selectedFilter = e.target.value;
    filterTransactions(selectedFilter);
});

document.getElementById('sortBy')?.addEventListener('change', (e) => {
    const sortOption = e.target.value;
    sortTransactions(sortOption);
});

function sortTransactions(sortBy) {
    const transactionList = document.getElementById('transactionList');
    const transactions = Array.from(transactionList.getElementsByClassName('transaction-item'));

    transactions.sort((a, b) => {
        if (sortBy === 'date') {
            const dateA = new Date(a.querySelector('.date').textContent.trim());
            const dateB = new Date(b.querySelector('.date').textContent.trim());
            return dateA - dateB; 
        } else if (sortBy === 'amount') {
            const amountA = parseFloat(a.querySelector('.amount').textContent.replace(/[^0-9.-]+/g, ''));
            const amountB = parseFloat(b.querySelector('.amount').textContent.replace(/[^0-9.-]+/g, ''));
            return amountA - amountB;
        }
    });

    transactions.forEach(transaction => transactionList.appendChild(transaction));
}

deleteButton.addEventListener('click', () => {
    console.log("Delete button clicked!"); 
    transactionItem.remove(); 
});

</script>
</body>
</html>
