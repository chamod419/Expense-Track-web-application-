<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Page</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Css/budget.css">
</head>
<body>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .sidebar {
      width: 250px;
      background-color: #1b3d5f;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      position: fixed;
      height: 100%;
      top: 0;
      left: 0;
      color: white;
    }
    
    .sidebar a {
            color: white;
            text-decoration: none;
            padding: 5px;
            display: block;
            font-size: 18px;
            }
    
    
        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-bottom: 40px;
        }
    
        .logo svg {
            width: 100px;
            height: 100px;
        }
    
        .logo-name {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-top: 10px;
        }
    
        .menu-section {
            padding-left: 20px;
        }
    
        .menu-section h3 {
            color: #ccc;
            margin-bottom: 10px;
        }
    
        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
        }
    
        .menu-item i {
            margin-right: 15px;
            font-size: 20px;
        }
    
        .menu-item:hover {
            background-color: #444;
        }
    
        .menu-item a {
            text-decoration: none;
            color: white;
            font-size: 16px;
        }
    
   
        .main-content {
            margin-left: 250px; 
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
          
            <div class="logo">
                <svg width="100" height="100" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M86.8467 11.5997H42.1533C22.74 11.5997 11.1667 23.173 11.1667 42.5863V87.2263C11.1667 106.693 22.74 118.266 42.1533 118.266H86.7933C106.207 118.266 117.78 106.693 117.78 87.2797V42.5863C117.833 23.173 106.26 11.5997 86.8467 11.5997ZM41.1933 97.733C41.1933 99.9197 39.38 101.733 37.1933 101.733C35.0067 101.733 33.1933 99.9197 33.1933 97.733V86.693C33.1933 84.5063 35.0067 82.693 37.1933 82.693C39.38 82.693 41.1933 84.5063 41.1933 86.693V97.733ZM68.5 97.733C68.5 99.9197 66.6867 101.733 64.5 101.733C62.3133 101.733 60.5 99.9197 60.5 97.733V75.5997C60.5 73.413 62.3133 71.5997 64.5 71.5997C66.6867 71.5997 68.5 73.413 68.5 75.5997V97.733ZM95.8067 97.733C95.8067 99.9197 93.9933 101.733 91.8067 101.733C89.62 101.733 87.8067 99.9197 87.8067 97.733V64.5597C87.8067 62.373 89.62 60.5597 91.8067 60.5597C93.9933 60.5597 95.8067 62.373 95.8067 64.5597V97.733ZM95.8067 47.7063C95.8067 49.893 93.9933 51.7063 91.8067 51.7063C89.62 51.7063 87.8067 49.893 87.8067 47.7063V42.533C74.2067 56.5063 57.1933 66.373 38.1533 71.1197C37.8333 71.2263 37.5133 71.2263 37.1933 71.2263C35.38 71.2263 33.78 69.9997 33.3 68.1863C32.7667 66.053 34.0467 63.8663 36.2333 63.333C54.2067 58.853 70.2067 49.413 82.9 36.0797H76.2333C74.0467 36.0797 72.2333 34.2663 72.2333 32.0797C72.2333 29.893 74.0467 28.0797 76.2333 28.0797H91.86C92.0733 28.0797 92.2333 28.1863 92.4467 28.1863C92.7133 28.2397 92.98 28.2397 93.2467 28.3463C93.5133 28.453 93.7267 28.613 93.9933 28.773C94.1533 28.8797 94.3133 28.933 94.4733 29.0397C94.5267 29.093 94.5267 29.1463 94.58 29.1463C94.7933 29.3597 94.9533 29.573 95.1133 29.7863C95.2733 29.9997 95.4333 30.1597 95.4867 30.373C95.5933 30.5863 95.5933 30.7997 95.6467 31.0663C95.7 31.333 95.8067 31.5997 95.8067 31.9197C95.8067 31.973 95.86 32.0263 95.86 32.0797V47.7063H95.8067Z" fill="#2CD7AE"/>
                </svg>
                <div class="logo-name">Track My Cash</div>
            </div>

          
            <div class="menu-section">
                <h3>Manage</h3>
                <div class="menu-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <a href="Dashboard.html">Dashboard</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <a href="transaction.html">Transactions</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <a href="report.html">Reports</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-tags"></i>
                    <a href="category.html">Categories</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-wallet"></i>
                    <a href="budget.html">Budget</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-file-invoice"></i>
                    <a href="receipts.html">Receipts</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-bullseye"></i>
                    <a href="goals.html">Goals</a>
                </div>
            </div>

           
            <div class="menu-section">
                <h3>Preferences</h3>
                <div class="menu-item">
                    <i class="fas fa-bell"></i>
                    <a href="notification.html">Notifications</a>
                </div>
                <div class="menu-item">
                    <i class="fas fa-cog"></i>
                    <a href="settings.html">Settings</a>
                </div>
            </div>
        </aside>


        <main class="main-content">
            <section class="budget-section">
                <header>
                    <h1>Budget</h1>
                    <button class="add-budget-btn">Add Budget</button>
                </header>
        
              
                <div class="budget-remaining">
                    <h2>Budget Remaining</h2>
                    <p id="budget-remaining-amount">LKR 0.00</p>
                </div>
        
                
                <div id="budget-details"></div>
            </section>
        </main>
    </div>

 
    <div id="addBudgetModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="budgetForm" class="modal-form">
                <label for="budgetType">Select Budget Type</label>
                <select id="budgetType" required>
                    <option value="Income Budget">Income Budget</option>
                    <option value="Expense Budget">Expense Budget</option>
                </select>
                <label for="budgetAmount">Enter the Budget</label>
                <input type="number" id="budgetAmount" required>
                <label for="actualAmount">Enter the Actual</label>
                <input type="number" id="actualAmount" required>
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

   
    <div id="addCategoryModal" class="category-modal">
        <div class="modal-content">
            <span class="close-category">&times;</span>
            <form id="categoryForm" class="modal-form">
                <h3 id="categoryBudgetType"></h3>
                <label for="categoryName">Enter Category Name</label>
                <input type="text" id="categoryName" list="categoryList" required>
                <datalist id="categoryList"></datalist>

                <label for="categoryBudgetAmount">Enter the Budget</label>
                <input type="number" id="categoryBudgetAmount" required>
                <label for="categoryActualAmount">Enter the Actual</label>
                <input type="number" id="categoryActualAmount" required>
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

 
    <script>
       
        const modal = document.getElementById("addBudgetModal");
        const categoryModal = document.getElementById("addCategoryModal");
        const addBudgetBtn = document.querySelector(".add-budget-btn");
        const closeBtn = document.querySelector(".close");
        const closeCategoryBtn = document.querySelector(".close-category");

        addBudgetBtn.onclick = () => modal.style.display = "block";

        closeBtn.onclick = () => modal.style.display = "none";
        closeCategoryBtn.onclick = () => categoryModal.style.display = "none";

        window.onclick = event => {
            if (event.target === modal) modal.style.display = "none";
            else if (event.target === categoryModal) categoryModal.style.display = "none";
        };

        
        window.onload = () => {
            const datalist = document.getElementById('categoryList');
            const categories = JSON.parse(localStorage.getItem('categories')) || [];

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                datalist.appendChild(option);
            });
        };

        document.getElementById("budgetForm").onsubmit = event => {
            event.preventDefault();

            const budgetType = document.getElementById("budgetType").value;
            const budgetAmount = parseFloat(document.getElementById("budgetAmount").value);
            const actualAmount = parseFloat(document.getElementById("actualAmount").value);
            const remainingAmount = budgetAmount - actualAmount;

            fetch('/add-budget', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ budgetType, budgetAmount, actualAmount })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);

                // Create new budget group
                const currentBudgetGroup = document.createElement("div");
                currentBudgetGroup.classList.add("budget-group");
                currentBudgetGroup.setAttribute("data-type", budgetType);
                currentBudgetGroup.innerHTML = `
                    <h3><i class="fa-solid fa-plus open-category-form"></i> ${budgetType}</h3>
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Budget</th>
                                <th>Actual</th>
                                <th>Remaining</th>
                            </tr>
                        </thead>
                        <tbody class="budget-content" style="display:none"></tbody>
                        <tfoot>
                            <tr>
                                <td>Total ${budgetType}</td>
                                <td>LKR ${budgetAmount.toFixed(2)}</td>
                                <td>LKR ${actualAmount.toFixed(2)}</td>
                                <td>LKR ${remainingAmount.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <button class="dropdown-btn"><i class="fa-solid fa-eye"></i> Show More</button>
                `;

                document.getElementById("budget-details").appendChild(currentBudgetGroup);

                currentBudgetGroup.querySelector(".open-category-form").addEventListener("click", () => {
                    categoryModal.style.display = "block";
                    document.getElementById("categoryBudgetType").textContent = budgetType;
                });

                currentBudgetGroup.querySelector(".dropdown-btn").addEventListener("click", toggleDetails);

                const totalRemaining = parseFloat(document.getElementById("budget-remaining-amount").textContent.replace("LKR", "").trim()) + remainingAmount;
                document.getElementById("budget-remaining-amount").textContent = `LKR ${totalRemaining.toFixed(2)}`;

                modal.style.display = "none";
            })
            .catch(error => console.error('Error:', error));
        };

        document.getElementById("categoryForm").onsubmit = event => {
            event.preventDefault();

            const categoryName = document.getElementById("categoryName").value;
            const categoryBudgetAmount = parseFloat(document.getElementById("categoryBudgetAmount").value);
            const categoryActualAmount = parseFloat(document.getElementById("categoryActualAmount").value);
            const categoryRemainingAmount = categoryBudgetAmount - categoryActualAmount;
            const budgetType = document.getElementById("categoryBudgetType").textContent;

            fetch('/add-category', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ budgetType, categoryName, categoryBudgetAmount, categoryActualAmount })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);

                const budgetGroup = document.querySelector(`#budget-details .budget-group[data-type="${budgetType}"]`);
                
                if (budgetGroup) {
                    const tbody = budgetGroup.querySelector("tbody");
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td>${categoryName}</td>
                        <td>LKR ${categoryBudgetAmount.toFixed(2)}</td>
                        <td>LKR ${categoryActualAmount.toFixed(2)}</td>
                        <td>LKR ${categoryRemainingAmount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(newRow);

                    const tfoot = budgetGroup.querySelector("tfoot");
                    const budgetCell = tfoot.querySelector("td:nth-child(2)");
                    const actualCell = tfoot.querySelector("td:nth-child(3)");
                    const remainingCell = tfoot.querySelector("td:nth-child(4)");

                    const totalBudget = parseFloat(budgetCell.textContent.replace("LKR", "").trim()) + categoryBudgetAmount;
                    const totalActual = parseFloat(actualCell.textContent.replace("LKR", "").trim()) + categoryActualAmount;
                    const totalRemaining = parseFloat(remainingCell.textContent.replace("LKR", "").trim()) + categoryRemainingAmount;

                    budgetCell.textContent = `LKR ${totalBudget.toFixed(2)}`;
                    actualCell.textContent = `LKR ${totalActual.toFixed(2)}`;
                    remainingCell.textContent = `LKR ${totalRemaining.toFixed(2)}`;

                    const budgetRemaining = parseFloat(document.getElementById("budget-remaining-amount").textContent.replace("LKR", "").trim()) + categoryRemainingAmount;
                    document.getElementById("budget-remaining-amount").textContent = `LKR ${budgetRemaining.toFixed(2)}`;
                }

                categoryModal.style.display = "none";
            })
            .catch(error => console.error('Error:', error));
        };

        function toggleDetails() {
            const budgetGroup = this.parentElement;
            const budgetContent = budgetGroup.querySelector(".budget-content");
            const isVisible = budgetContent.style.display === "table-row-group";
            budgetContent.style.display = isVisible ? "none" : "table-row-group";
            this.textContent = isVisible ? "Show More" : "Show Less";
        }
    </script>
</body>
</html>
